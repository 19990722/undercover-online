<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>谁是卧底 - 联机版（稳定修复版）</title>
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Microsoft YaHei', Arial, sans-serif; }
        body { background-color: #f5f7fa; padding: 15px; min-height: 100vh; }
        .container { max-width: 1000px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; box-shadow: 0 2px 15px rgba(0,0,0,0.08); padding: 20px; margin-bottom: 20px; }
        .card-header { font-size: 18px; font-weight: 600; margin-bottom: 15px; color: #2d3748; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; transition: all 0.3s; }
        .btn-primary { background-color: #4299e1; color: white; }
        .btn-success { background-color: #48bb78; color: white; }
        .btn-danger { background-color: #e53e3e; color: white; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .input { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 16px; margin-bottom: 15px; outline: none; }
        .input:focus { border-color: #4299e1; box-shadow: 0 0 0 2px rgba(66, 153, 225, 0.1); }
        .flex { display: flex; gap: 10px; }
        .flex-wrap { flex-wrap: wrap; }
        .justify-between { justify-content: space-between; }
        .align-center { align-items: center; }
        .text-center { text-align: center; }
        .mb-10 { margin-bottom: 10px; }
        .mb-20 { margin-bottom: 20px; }
        .player-card { background-color: #f0f8fb; border-radius: 8px; padding: 15px; width: calc(20% - 8px); text-align: center; transition: all 0.3s; }
        @media (max-width: 768px) {
            .player-card { width: calc(33.33% - 7px); }
        }
        @media (max-width: 480px) {
            .player-card { width: calc(50% - 5px); }
        }
        .player-card.alive { border: 2px solid #48bb78; }
        .player-card.dead { border: 2px solid #e53e3e; opacity: 0.7; }
        .player-card.you { background-color: #e8f4f8; border: 2px solid #4299e1; }
        .speech-list { max-height: 300px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .speech-item { margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #f7fafc; }
        .speech-name { font-weight: 600; color: #4299e1; margin-bottom: 4px; }
        .speech-time { font-size: 12px; color: #999; margin-left: 8px; }
        .speech-content { color: #4a5568; }
        .vote-item { background-color: #f0f8fb; border-radius: 20px; padding: 8px 16px; cursor: pointer; transition: all 0.3s; }
        .vote-item.selected { background-color: #4299e1; color: white; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; border-radius: 12px; padding: 30px; width: 90%; max-width: 500px; }
        .hidden { display: none; }
        .role-tag { display: inline-block; padding: 5px 10px; border-radius: 6px; color: white; font-weight: 600; }
        .role-civilian { background-color: #48bb78; }
        .role-spy { background-color: #e53e3e; }
        .role-blank { background-color: #ed8936; }
        .page { animation: fadeIn 0.3s ease; }
        .error-tip { color: #e53e3e; font-size: 14px; margin-top: -10px; margin-bottom: 10px; display: none; }
        .loading-tip { color: #4299e1; font-size: 16px; text-align: center; margin: 15px 0; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 房间入口页 -->
        <div id="room-entry" class="page">
            <div class="card">
                <div class="card-header">谁是卧底 - 联机版（稳定修复版）</div>
                <input type="text" id="player-name" class="input" placeholder="请输入你的昵称（最多8字）" maxlength="8">
                <div id="name-error" class="error-tip">请输入有效的昵称！</div>
                <div class="flex">
                    <button class="btn btn-primary" id="create-room-btn">创建房间</button>
                    <button class="btn btn-success" id="join-room-btn">加入房间</button>
                </div>
                <div id="create-error" class="error-tip">创建房间失败，请重试！</div>
            </div>

            <!-- 加入房间弹窗 -->
            <div id="join-modal" class="modal hidden">
                <div class="modal-content">
                    <div class="card-header mb-20">加入房间</div>
                    <input type="text" id="room-id-input" class="input" placeholder="请输入6位房间号">
                    <div id="room-id-error" class="error-tip">请输入6位数字房间号！</div>
                    <div id="join-loading" class="loading-tip hidden">正在连接房间...请稍候</div>
                    <div class="flex justify-between">
                        <button class="btn btn-danger" id="cancel-join-btn">取消</button>
                        <button class="btn btn-primary" id="confirm-join-btn">确认加入</button>
                    </div>
                    <div id="join-error" class="error-tip text-center" style="margin-top: 10px;">房间不存在或已开始游戏！</div>
                    <div id="join-timeout-error" class="error-tip text-center" style="margin-top: 10px; display: none;">连接超时，请检查房间号或提醒房主进入房间</div>
                </div>
            </div>

            <!-- 房间创建成功弹窗 -->
            <div id="create-success-modal" class="modal hidden">
                <div class="modal-content">
                    <div class="card-header mb-20">房间创建成功</div>
                    <p class="mb-10">你的房间号：<span id="created-room-id" style="font-size: 24px; color: #4299e1; font-weight: 600;"></span></p>
                    <p class="mb-20 text-center" style="color: #666;">复制房间号分享给好友，点击下方按钮进入房间等待</p>
                    <button class="btn btn-primary w-100" id="enter-room-btn">进入游戏房间</button>
                </div>
            </div>
        </div>

        <!-- 游戏房间页 -->
        <div id="game-room" class="page hidden">
            <div class="card">
                <div class="flex justify-between align-center mb-20">
                    <h2>房间号：<span id="current-room-id"></span> <span id="game-status" style="color: #48bb78; font-size: 16px; font-weight: normal;">（等待中）</span></h2>
                    <button class="btn btn-danger" id="leave-room-btn">离开房间</button>
                </div>

                <!-- 玩家列表 -->
                <div class="card-header">玩家列表（<span id="player-count">0</span>/12）</div>
                <div id="player-list" class="flex flex-wrap gap-10 mb-20"></div>
                <button id="start-game-btn" class="btn btn-primary hidden" disabled>开始游戏（需4人以上）</button>

                <!-- 游戏内容区（游戏开始后显示） -->
                <div id="game-content" class="hidden">
                    <!-- 个人身份信息 -->
                    <div class="card mb-20">
                        <div class="card-header">你的身份</div>
                        <p class="mb-10">身份：<span id="my-role" class="role-tag"></span></p>
                        <p id="my-word" class="mb-10 hidden">词语：<span style="font-size: 18px; color: #48bb78; font-weight: 600;"></span></p>
                        <p id="blank-tip" class="mb-10 hidden" style="color: #ed8936;">提示：你没有词语，请模仿他人发言隐藏身份</p>
                    </div>

                    <!-- 发言区 -->
                    <div class="card mb-20">
                        <div class="card-header">发言记录</div>
                        <div id="speech-list" class="speech-list"></div>
                        <input type="text" id="speech-input" class="input" placeholder="请输入发言（1-3句话，不能包含词语中的字）" maxlength="100">
                        <div id="speech-error" class="error-tip">发言不能包含词语中的字！</div>
                        <button class="btn btn-success" id="submit-speech-btn">提交发言</button>
                    </div>

                    <!-- 投票区 -->
                    <div id="vote-section" class="card hidden">
                        <div class="card-header">投票环节</div>
                        <p class="mb-10">选择你怀疑的玩家：</p>
                        <div id="vote-list" class="flex flex-wrap gap-10 mb-15"></div>
                        <button class="btn btn-primary" id="submit-vote-btn" disabled>提交投票</button>
                    </div>
                </div>
            </div>

            <!-- 游戏结束弹窗 -->
            <div id="game-end-modal" class="modal hidden">
                <div class="modal-content">
                    <div class="card-header mb-20">游戏结束</div>
                    <p class="mb-10">获胜阵营：<span id="winner-text" style="font-size: 20px; color: #ed8936; font-weight: 600;"></span></p>
                    <p class="mb-10">获胜原因：<span id="win-reason"></span></p>
                    <div class="mb-20">
                        <p class="mb-10">最终身份列表：</p>
                        <div id="final-role-list"></div>
                    </div>
                    <div class="flex justify-between">
                        <button class="btn btn-success" id="restart-game-btn">再来一局</button>
                        <button class="btn btn-danger" id="back-home-btn">返回首页</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局状态（不依赖外部数据库，用 Pusher 实时同步）
        let currentUser = {
            id: Math.random().toString(36).substr(2, 9), // 随机用户ID
            name: ''
        };
        let currentRoom = { id: '', isHost: false };
        let gameState = {
            players: [], // { id, name, role, isAlive }
            wordPair: { civilian: '', spy: '' },
            status: 'waiting', // waiting/playing/ended
            speeches: [], // { playerId, playerName, content, time }
            votes: {}, // { voterId: targetId }
            speechCount: 0 // 已发言人数
        };
        // 加入房间超时计时器
        let joinRoomTimer = null;

        // 词语库（新增更多词语对，提升游戏多样性）
        const wordLibrary = [
            { civilian: "奶茶", spy: "果汁" },
            { civilian: "手机", spy: "平板" },
            { civilian: "火锅", spy: "烧烤" },
            { civilian: "猫", spy: "狗" },
            { civilian: "电影", spy: "电视剧" },
            { civilian: "米饭", spy: "面条" },
            { civilian: "篮球", spy: "足球" },
            { civilian: "耳机", spy: "音箱" },
            { civilian: "雨伞", spy: "雨衣" },
            { civilian: "火车", spy: "高铁" },
            { civilian: "钢笔", spy: "中性笔" },
            { civilian: "面包", spy: "蛋糕" },
            { civilian: "拖鞋", spy: "凉鞋" },
            { civilian: "台灯", spy: "吊灯" },
            { civilian: "自行车", spy: "电动车" },
            { civilian: "咖啡", spy: "茶" },
            { civilian: "电脑", spy: "笔记本" },
            { civilian: "沙发", spy: "椅子" },
            { civilian: "口红", spy: "唇釉" },
            { civilian: "跑步", spy: "散步" }
        ];

        // DOM 元素缓存
        const DOM = {
            // 页面
            roomEntryPage: document.getElementById('room-entry'),
            gameRoomPage: document.getElementById('game-room'),
            // 弹窗
            joinModal: document.getElementById('join-modal'),
            createSuccessModal: document.getElementById('create-success-modal'),
            gameEndModal: document.getElementById('game-end-modal'),
            // 输入框
            playerName: document.getElementById('player-name'),
            roomIdInput: document.getElementById('room-id-input'),
            speechInput: document.getElementById('speech-input'),
            // 错误提示
            nameError: document.getElementById('name-error'),
            createError: document.getElementById('create-error'),
            roomIdError: document.getElementById('room-id-error'),
            joinError: document.getElementById('join-error'),
            joinTimeoutError: document.getElementById('join-timeout-error'),
            speechError: document.getElementById('speech-error'),
            // 加载提示
            joinLoading: document.getElementById('join-loading'),
            // 按钮
            createRoomBtn: document.getElementById('create-room-btn'),
            joinRoomBtn: document.getElementById('join-room-btn'),
            cancelJoinBtn: document.getElementById('cancel-join-btn'),
            confirmJoinBtn: document.getElementById('confirm-join-btn'),
            enterRoomBtn: document.getElementById('enter-room-btn'),
            leaveRoomBtn: document.getElementById('leave-room-btn'),
            startGameBtn: document.getElementById('start-game-btn'),
            submitSpeechBtn: document.getElementById('submit-speech-btn'),
            submitVoteBtn: document.getElementById('submit-vote-btn'),
            restartGameBtn: document.getElementById('restart-game-btn'),
            backHomeBtn: document.getElementById('back-home-btn'),
            // 显示元素
            createdRoomId: document.getElementById('created-room-id'),
            currentRoomId: document.getElementById('current-room-id'),
            gameStatus: document.getElementById('game-status'),
            playerCount: document.getElementById('player-count'),
            playerList: document.getElementById('player-list'),
            gameContent: document.getElementById('game-content'),
            myRole: document.getElementById('my-role'),
            myWord: document.getElementById('my-word'),
            blankTip: document.getElementById('blank-tip'),
            speechList: document.getElementById('speech-list'),
            voteSection: document.getElementById('vote-section'),
            voteList: document.getElementById('vote-list'),
            winnerText: document.getElementById('winner-text'),
            winReason: document.getElementById('win-reason'),
            finalRoleList: document.getElementById('final-role-list')
        };

        // 初始化 Pusher（免费公共集群，无需注册）
        const pusher = new Pusher('c720ae6f0d8d874e14c9', {
            cluster: 'ap1',
            forceTLS: true
        });

        // 初始化事件监听
        function initEvents() {
            // 房间入口页
            DOM.createRoomBtn.addEventListener('click', handleCreateRoom);
            DOM.joinRoomBtn.addEventListener('click', () => {
                DOM.joinError.style.display = 'none';
                DOM.joinTimeoutError.style.display = 'none';
                DOM.roomEntryPage.classList.add('hidden');
                DOM.joinModal.classList.remove('hidden');
            });
            DOM.cancelJoinBtn.addEventListener('click', () => {
                // 清除超时计时器
                if (joinRoomTimer) clearTimeout(joinRoomTimer);
                DOM.joinModal.classList.add('hidden');
                DOM.roomEntryPage.classList.remove('hidden');
            });
            DOM.confirmJoinBtn.addEventListener('click', handleJoinRoom);
            DOM.enterRoomBtn.addEventListener('click', enterGameRoom);

            // 游戏房间页
            DOM.leaveRoomBtn.addEventListener('click', handleLeaveRoom);
            DOM.startGameBtn.addEventListener('click', handleStartGame);
            DOM.submitSpeechBtn.addEventListener('click', handleSubmitSpeech);
            DOM.submitVoteBtn.addEventListener('click', handleSubmitVote);
            DOM.restartGameBtn.addEventListener('click', handleRestartGame);
            DOM.backHomeBtn.addEventListener('click', () => window.location.reload());

            // 输入框限制
            DOM.playerName.addEventListener('input', (e) => {
                e.target.value = e.target.value.trim();
                DOM.nameError.style.display = 'none';
            });
            DOM.roomIdInput.addEventListener('input', (e) => {
                e.target.value = e.target.value.trim().replace(/[^0-9]/g, '');
                DOM.roomIdError.style.display = 'none';
                DOM.joinError.style.display = 'none';
                DOM.joinTimeoutError.style.display = 'none';
            });
            DOM.speechInput.addEventListener('keyup', (e) => {
                e.key === 'Enter' && handleSubmitSpeech();
                DOM.speechError.style.display = 'none';
            });
        }

        // 1. 创建房间（核心修复：提前绑定状态请求监听，确保新玩家能获取房间数据）
        function handleCreateRoom() {
            const name = DOM.playerName.value.trim();
            if (!name) {
                DOM.nameError.style.display = 'block';
                return;
            }

            // 生成6位房间号（确保唯一且易记）
            const roomId = Math.floor(100000 + Math.random() * 900000).toString();
            currentUser.name = name;
            currentRoom.id = roomId;
            currentRoom.isHost = true;

            // 初始化房间数据
            gameState = {
                players: [{ id: currentUser.id, name, role: null, isAlive: true }],
                wordPair: wordLibrary[Math.floor(Math.random() * wordLibrary.length)],
                status: 'waiting',
                speeches: [],
                votes: {},
                speechCount: 0
            };

            try {
                // 订阅房间频道（Pusher 实时通信）
                const channel = pusher.subscribe(`room-${roomId}`);
                
                // 【关键修复1】创建房间后立即绑定状态请求监听，无需等待进入房间
                channel.bind('client-request-room-state', () => {
                    channel.trigger('client-room-updated', gameState);
                });

                // 同步房间初始数据到频道
                channel.trigger('client-room-updated', gameState);

                // 显示创建成功弹窗
                DOM.createdRoomId.textContent = roomId;
                DOM.createSuccessModal.classList.remove('hidden');
                DOM.createError.style.display = 'none';
            } catch (err) {
                console.error('创建房间失败：', err);
                DOM.createError.style.display = 'block';
            }
        }

        // 2. 加入房间（核心修复：提前绑定状态更新监听+超时处理）
        function handleJoinRoom() {
            const name = DOM.playerName.value.trim();
            const roomId = DOM.roomIdInput.value.trim();

            if (!name) {
                DOM.nameError.style.display = 'block';
                return;
            }
            if (roomId.length !== 6) {
                DOM.roomIdError.style.display = 'block';
                return;
            }

            // 显示加载提示，隐藏错误提示，禁用按钮防止重复点击
            DOM.confirmJoinBtn.disabled = true;
            DOM.joinLoading.classList.remove('hidden');
            DOM.joinError.style.display = 'none';
            DOM.joinTimeoutError.style.display = 'none';

            currentUser.name = name;
            currentRoom.id = roomId;
            currentRoom.isHost = false;

            try {
                // 订阅目标房间频道
                const channel = pusher.subscribe(`room-${roomId}`);
                
                // 【关键修复2】订阅后立即绑定状态更新监听，确保不遗漏同步信息
                channel.bind('client-room-updated', (updatedState) => {
                    // 清除超时计时器
                    if (joinRoomTimer) clearTimeout(joinRoomTimer);
                    // 恢复按钮状态与加载提示
                    DOM.confirmJoinBtn.disabled = false;
                    DOM.joinLoading.classList.add('hidden');

                    // 验证房间状态
                    if (!updatedState) {
                        DOM.joinError.style.display = 'block';
                        return;
                    }
                    if (updatedState.status !== 'waiting') {
                        DOM.joinError.style.display = 'block';
                        return;
                    }
                    if (updatedState.players.length >= 12) {
                        DOM.joinError.style.display = 'block';
                        return;
                    }

                    // 检查当前玩家是否已在房间内（避免重复加入）
                    const isAlreadyIn = updatedState.players.some(p => p.id === currentUser.id);
                    if (isAlreadyIn) {
                        gameState = updatedState;
                        DOM.joinModal.classList.add('hidden');
                        enterGameRoom();
                        return;
                    }

                    // 添加新玩家
                    const newPlayer = { id: currentUser.id, name, role: null, isAlive: true };
                    gameState = { ...updatedState, players: [...updatedState.players, newPlayer] };

                    // 同步更新到房间频道
                    channel.trigger('client-room-updated', gameState);

                    // 进入游戏房间
                    DOM.joinModal.classList.add('hidden');
                    enterGameRoom();
                });

                // 【关键修复3】添加5秒超时处理，避免无限等待
                joinRoomTimer = setTimeout(() => {
                    DOM.confirmJoinBtn.disabled = false;
                    DOM.joinLoading.classList.add('hidden');
                    DOM.joinTimeoutError.style.display = 'block';
                    // 退订无效频道，释放资源
                    pusher.unsubscribe(`room-${roomId}`);
                }, 5000);

                // 触发数据请求，让房主返回当前房间状态
                channel.trigger('client-request-room-state', {});
            } catch (err) {
                console.error('加入房间失败：', err);
                DOM.confirmJoinBtn.disabled = false;
                DOM.joinLoading.classList.add('hidden');
                DOM.joinError.style.display = 'block';
            }
        }

        // 3. 进入游戏房间
        function enterGameRoom() {
            DOM.roomEntryPage.classList.add('hidden');
            DOM.gameRoomPage.classList.remove('hidden');
            DOM.currentRoomId.textContent = currentRoom.id;
            updatePlayerList();

            // 房主显示开始按钮并更新状态
            if (currentRoom.isHost) {
                DOM.startGameBtn.classList.remove('hidden');
                updateStartBtnStatus();
            } else {
                // 非房主持续监听房间数据变化
                const channel = pusher.channel(`room-${currentRoom.id}`);
                channel.bind('client-room-updated', (updatedState) => {
                    gameState = updatedState;
                    updatePlayerList();
                    updateMyRoleInfo();
                    updateSpeechList();
                    updateVoteSection();
                    updateVoteList();

                    // 投票完成后自动处理结果
                    if (gameState.status === 'playing' && Object.keys(gameState.votes).length === getAliveCount()) {
                        setTimeout(handleVoteResult, 500);
                    }
                });
            }
        }

        // 4. 开始游戏
        function handleStartGame() {
            if (gameState.players.length < 4) return alert('至少4人才能开始游戏！');

            // 分配身份（根据人数调整卧底数量）
            const playerCount = gameState.players.length;
            const roleCount = {
                spy: playerCount > 10 ? 2 : 1, // 10人以上2个卧底，否则1个
                blank: 1, // 固定1个白板
                civilian: playerCount - (playerCount > 10 ? 2 : 1) - 1 // 剩余为平民
            };

            // 打乱玩家顺序，公平分配身份
            const shuffledPlayers = [...gameState.players].sort(() => Math.random() - 0.5);
            shuffledPlayers.forEach((player, index) => {
                if (index < roleCount.spy) {
                    player.role = 'spy';
                } else if (index < roleCount.spy + roleCount.blank) {
                    player.role = 'blank';
                } else {
                    player.role = 'civilian';
                }
            });

            // 更新游戏状态
            gameState = {
                ...gameState,
                players: shuffledPlayers,
                status: 'playing',
                speeches: [],
                votes: {},
                speechCount: 0
            };

            // 同步到所有玩家
            const channel = pusher.channel(`room-${currentRoom.id}`);
            channel.trigger('client-room-updated', gameState);

            // 自己更新UI
            DOM.gameContent.classList.remove('hidden');
            updateMyRoleInfo();
            DOM.gameStatus.textContent = "（游戏中）";
            DOM.gameStatus.style.color = "#ed8936"; // 游戏中显示橙色状态
        }

        // 5. 提交发言
        function handleSubmitSpeech() {
            const content = DOM.speechInput.value.trim();
            if (!content) return alert('请输入发言内容！');

            // 检查是否已发言（每人每轮仅1次发言机会）
            const hasSpoken = gameState.speeches.some(speech => speech.playerId === currentUser.id);
            if (hasSpoken) return alert('你已完成本轮发言，不能重复发言！');

            // 校验：平民/卧底不能包含自己词语中的字
            const myPlayer = gameState.players.find(p => p.id === currentUser.id);
            if (!myPlayer) return;

            const myWord = myPlayer.role === 'civilian' 
                ? gameState.wordPair.civilian 
                : myPlayer.role === 'spy' 
                    ? gameState.wordPair.spy 
                    : '';

            if (myPlayer.role !== 'blank' && myWord.split('').some(char => content.includes(char))) {
                DOM.speechError.style.display = 'block';
                return;
            }

            // 新增发言记录
            const newSpeech = {
                playerId: currentUser.id,
                playerName: currentUser.name,
                content: content,
                time: new Date().toLocaleTimeString() // 显示发言时间
            };

            // 更新游戏状态
            gameState = {
                ...gameState,
                speeches: [...gameState.speeches, newSpeech],
                speechCount: gameState.speechCount + 1
            };

            // 同步到所有玩家
            const channel = pusher.channel(`room-${currentRoom.id}`);
            channel.trigger('client-room-updated', gameState);

            // 清空输入框，隐藏错误提示
            DOM.speechInput.value = '';
            DOM.speechError.style.display = 'none';
        }

        // 6. 提交投票
        function handleSubmitVote() {
            const selectedPlayer = document.querySelector('.vote-item.selected');
            if (!selectedPlayer) return alert('请选择你要投票淘汰的玩家！');

            const targetPlayerId = selectedPlayer.dataset.playerId;
            // 记录当前玩家的投票
            gameState.votes[currentUser.id] = targetPlayerId;

            // 同步到所有玩家
            const channel = pusher.channel(`room-${currentRoom.id}`);
            channel.trigger('client-room-updated', gameState);

            // 投票后禁用投票区，防止重复投票
            DOM.voteList.querySelectorAll('.vote-item').forEach(item => item.style.pointerEvents = 'none');
        }

        // 7. 处理投票结果
        function handleVoteResult() {
            // 统计投票数
            const voteCount = {};
            Object.values(gameState.votes).forEach(targetId => {
                voteCount[targetId] = (voteCount[targetId] || 0) + 1;
            });

            // 找出得票最高者（处理平票：取第一个得票最高的玩家）
            let maxVotes = 0;
            let eliminatedPlayerId = null;
            Object.entries(voteCount).forEach(([playerId, count]) => {
                if (count > maxVotes) {
                    maxVotes = count;
                    eliminatedPlayerId = playerId;
                }
            });

            // 标记被淘汰玩家为死亡状态
            const updatedPlayers = gameState.players.map(player => {
                if (player.id === eliminatedPlayerId) {
                    player.isAlive = false;
                }
                return player;
            });

            // 检查游戏是否结束（判断阵营胜负）
            const aliveSpies = updatedPlayers.filter(p => p.isAlive && p.role === 'spy').length;
            const aliveCivilians = updatedPlayers.filter(p => p.isAlive && p.role === 'civilian').length;
            let gameResult = null;

            if (aliveSpies === 0) {
                // 所有卧底被淘汰，平民&白板获胜
                gameResult = { winner: 'civilian&blank', reason: '所有卧底已被淘汰' };
            } else if (aliveSpies >= aliveCivilians) {
                // 卧底人数≥平民人数，卧底获胜
                gameResult = { winner: 'spy', reason: '卧底人数≥平民人数' };
            }

            // 更新游戏状态
            gameState = {
                ...gameState,
                players: updatedPlayers,
                votes: {}, // 重置投票数据
                speechCount: 0, // 重置发言计数
                speeches: [], // 重置发言记录
                status: gameResult ? 'ended' : 'playing' // 游戏结束或继续
            };

            // 同步到所有玩家
            const channel = pusher.channel(`room-${currentRoom.id}`);
            channel.trigger('client-room-updated', gameState);

            // 显示游戏结束弹窗（若游戏结束）
            if (gameResult) {
                DOM.gameStatus.textContent = "（游戏结束）";
                DOM.gameStatus.style.color = "#e53e3e"; // 游戏结束显示红色状态
                showGameEndModal(gameResult, updatedPlayers);
            }
        }

        // 8. 再来一局（仅房主可发起）
        function handleRestartGame() {
            if (!currentRoom.isHost) return alert('仅房主可发起再来一局！');

            // 重置玩家状态（保留玩家列表，重置身份和存活状态）
            const resetPlayers = gameState.players.map(player => ({
                ...player,
                role: null,
                isAlive: true
            }));
            // 重新随机抽取词语对
            const newWordPair = wordLibrary[Math.floor(Math.random() * wordLibrary.length)];

            // 重置游戏状态
            gameState = {
                players: resetPlayers,
                wordPair: newWordPair,
                status: 'waiting',
                speeches: [],
                votes: {},
                speechCount: 0
            };

            // 同步到所有玩家
            const channel = pusher.channel(`room-${currentRoom.id}`);
            channel.trigger('client-room-updated', gameState);

            // 自己更新UI
            DOM.gameEndModal.classList.add('hidden');
            DOM.gameContent.classList.add('hidden');
            DOM.voteSection.classList.add('hidden');
            DOM.gameStatus.textContent = "（等待中）";
            DOM.gameStatus.style.color = "#48bb78"; // 等待中显示绿色状态
            updatePlayerList();
            updateStartBtnStatus();
        }

        // 9. 离开房间
        function handleLeaveRoom() {
            if (!confirm('确定要离开房间吗？离开后将无法继续当前游戏！')) return;

            // 移除当前玩家
            const updatedPlayers = gameState.players.filter(player => player.id !== currentUser.id);

            // 同步更新到房间（若还有其他玩家）
            if (updatedPlayers.length > 0) {
                gameState = { ...gameState, players: updatedPlayers };
                const channel = pusher.channel(`room-${currentRoom.id}`);
                channel.trigger('client-room-updated', gameState);
            }

            // 退订房间频道，释放资源
            pusher.unsubscribe(`room-${currentRoom.id}`);

            // 返回首页
            window.location.reload();
        }

        // 辅助函数：更新玩家列表UI
        function updatePlayerList() {
            DOM.playerList.innerHTML = '';
            DOM.playerCount.textContent = gameState.players.length;

            gameState.players.forEach(player => {
                const isCurrentUser = player.id === currentUser.id;
                const playerCard = document.createElement('div');
                playerCard.className = `player-card ${player.isAlive ? 'alive' : 'dead'} ${isCurrentUser ? 'you' : ''}`;
                playerCard.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 5px;">${player.name}</div>
                    <div style="font-size: 14px; color: #666;">${player.isAlive ? '存活' : '已淘汰'}</div>
                    ${isCurrentUser ? '<div style="color: #4299e1; font-size: 12px; margin-top: 5px;">（你）</div>' : ''}
                `;
                DOM.playerList.appendChild(playerCard);
            });

            // 非房主显示等待状态
            if (!currentRoom.isHost) {
                DOM.startGameBtn.classList.remove('hidden');
                if (gameState.players.length >= 4) {
                    DOM.startGameBtn.disabled = true;
                    DOM.startGameBtn.textContent = `等待房主开始（${gameState.players.length}/4人）`;
                } else {
                    DOM.startGameBtn.disabled = true;
                    DOM.startGameBtn.textContent = `等待更多玩家（${gameState.players.length}/4人）`;
                }
            }
        }

        // 辅助函数：更新房主的开始按钮状态
        function updateStartBtnStatus() {
            if (gameState.players.length >= 4) {
                DOM.startGameBtn.disabled = false;
                DOM.startGameBtn.textContent = `开始游戏（${gameState.players.length}/4人）`;
            } else {
                DOM.startGameBtn.disabled = true;
                DOM.startGameBtn.textContent = `开始游戏（${gameState.players.length}/4人）`;
            }
        }

        // 辅助函数：更新个人身份信息UI
        function updateMyRoleInfo() {
            const myPlayer = gameState.players.find(player => player.id === currentUser.id);
            if (!myPlayer || !myPlayer.role) return;

            // 更新身份标签
            if (myPlayer.role === 'civilian') {
                DOM.myRole.className = 'role-tag role-civilian';
                DOM.myRole.textContent = '平民';
                DOM.myWord.classList.remove('hidden');
                DOM.myWord.querySelector('span').textContent = gameState.wordPair.civilian;
                DOM.blankTip.classList.add('hidden');
            } else if (myPlayer.role === 'spy') {
                DOM.myRole.className = 'role-tag role-spy';
                DOM.myRole.textContent = '卧底';
                DOM.myWord.classList.remove('hidden');
                DOM.myWord.querySelector('span').textContent = gameState.wordPair.spy;
                DOM.blankTip.classList.add('hidden');
            } else if (myPlayer.role === 'blank') {
                DOM.myRole.className = 'role-tag role-blank';
                DOM.myRole.textContent = '白板';
                DOM.myWord.classList.add('hidden');
                DOM.blankTip.classList.remove('hidden');
            }
        }

        // 辅助函数：更新发言列表UI
        function updateSpeechList() {
            DOM.speechList.innerHTML = '';
            gameState.speeches.forEach(speech => {
                const speechItem = document.createElement('div');
                speechItem.className = 'speech-item';
                speechItem.innerHTML = `
                    <div class="speech-name">
                        ${speech.playerName}
                        <span class="speech-time">${speech.time}</span>
                    </div>
                    <div class="speech-content">${speech.content}</div>
                `;
                DOM.speechList.appendChild(speechItem);
            });
            // 自动滚动到底部，显示最新发言
            DOM.speechList.scrollTop = DOM.speechList.scrollHeight;
        }

        // 辅助函数：更新投票区显示状态
        function updateVoteSection() {
            const myPlayer = gameState.players.find(p => p.id === currentUser.id);
            const isAlive = myPlayer ? myPlayer.isAlive : false;
            const hasSpoken = gameState.speeches.some(s => s.playerId === currentUser.id);
            const allPlayersSpoken = gameState.speechCount === getAliveCount();

            // 存活+已发言+所有人都发言了，才显示投票区
            if (isAlive && hasSpoken && allPlayersSpoken) {
                DOM.voteSection.classList.remove('hidden');
                updateVoteList(); // 刷新投票列表
            } else {
                DOM.voteSection.classList.add('hidden');
            }
        }

        // 辅助函数：更新投票列表UI
        function updateVoteList() {
            DOM.voteList.innerHTML = '';
            DOM.submitVoteBtn.disabled = true;

            // 只能投票给存活的其他玩家
            const validTargets = gameState.players.filter(player => 
                player.isAlive && player.id !== currentUser.id
            );

            validTargets.forEach(target => {
                const voteItem = document.createElement('div');
                voteItem.className = 'vote-item';
                voteItem.dataset.playerId = target.id;
                voteItem.textContent = target.name;
                // 点击选中投票目标
                voteItem.addEventListener('click', () => {
                    document.querySelectorAll('.vote-item').forEach(item => item.classList.remove('selected'));
                    voteItem.classList.add('selected');
                    DOM.submitVoteBtn.disabled = false;
                });
                DOM.voteList.appendChild(voteItem);
            });
        }

        // 辅助函数：显示游戏结束弹窗
        function showGameEndModal(result, players) {
            DOM.winnerText.textContent = result.winner === 'civilian&blank' ? '平民&白板阵营' : '卧底阵营';
            DOM.winReason.textContent = result.reason;
            DOM.finalRoleList.innerHTML = '';

            // 显示所有玩家的最终身份
            players.forEach(player => {
                const roleText = player.role === 'civilian' ? '平民' : player.role === 'spy' ? '卧底' : '白板';
                const roleColor = player.role === 'civilian' ? '#48bb78' : player.role === 'spy' ? '#e53e3e' : '#ed8936';
                DOM.finalRoleList.innerHTML += `
                    <div style="margin-bottom: 6px; font-size: 14px;">
                        ${player.name} - <span style="color: ${roleColor}; font-weight: 600;">${roleText}</span>
                        （${player.isAlive ? '存活' : '已淘汰'}）
                    </div>
                `;
            });

            DOM.gameEndModal.classList.remove('hidden');
        }

        // 辅助函数：获取存活玩家数量
        function getAliveCount() {
            return gameState.players.filter(player => player.isAlive).length;
        }

        // 初始化游戏（绑定所有事件）
        initEvents();
    </script>
</body>
</html>